<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CSVã‹ã‚“ãŸã‚“å¤‰æ›ãƒ„ãƒ¼ãƒ«</title>
<style>
/* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆçœç•¥å¯ï¼‰ */
body{font-family:'Meiryo',sans-serif;padding:20px;background:#f8f9fa;}
.container{max-width:900px;margin:0 auto;}
.header{background:#0066cc;color:white;padding:20px;border-radius:12px;text-align:center;margin-bottom:20px;}
.header h1{font-size:2em;}
.section{background:white;padding:20px;border-radius:12px;margin-bottom:20px;}
.file-input-wrapper{border:2px dashed #ccc;padding:40px;text-align:center;border-radius:8px;cursor:pointer;position:relative;}
.file-input-wrapper input[type="file"]{position:absolute;opacity:0;width:100%;height:100%;top:0;left:0;cursor:pointer;}
.table-preview{width:100%;border-collapse:collapse;margin-top:15px;}
.table-preview th,.table-preview td{border:1px solid #ccc;padding:8px;text-align:left;}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ“¦ CSVã‹ã‚“ãŸã‚“å¤‰æ›ãƒ„ãƒ¼ãƒ«</h1>
    <p>åŸºå¹¹ã‚·ã‚¹ãƒ†ãƒ CSVã‚’å®…é…ä¾¿ç”¨ã«å¤‰æ›ã—ã¾ã™</p>
  </div>

  <div class="section">
    <h2>CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
    <div class="file-input-wrapper" id="fileWrapper">
      <input type="file" id="csvFile" accept=".csv">
      <div>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§CSVã‚’é¸æŠ</div>
      <div id="fileName"></div>
    </div>
  </div>

  <div class="section">
    <h2>é…é€ä¼šç¤¾é¸æŠ</h2>
    <select id="courierSelect"></select>
  </div>

  <div class="section">
    <button id="convertBtn" disabled>å¤‰æ›ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
    <button id="downloadBtn" style="display:none;">CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
  </div>

  <div class="section" id="previewSection" style="display:none;">
    <h2>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
    <div id="previewContent"></div>
  </div>
</div>

<script>
// ==================== è¨­å®š ====================
const COURIER_NAMES = {Yamato:'ãƒ¤ãƒãƒˆé‹è¼¸',Sagawa:'ä½å·æ€¥ä¾¿',JapanPost:'æ—¥æœ¬éƒµä¾¿'};
let formats = {};
let csvRows = [];

// ==================== CSVãƒ‘ãƒ¼ã‚¹ ====================
function parseCsv(text){
  const rows = [], r = [], vbuf='', iq=false;
  let rbuf=[], v='', inQuotes=false;
  let vbuf2='', iq2=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], next=text[i+1];
    if(c=='"'&&!iq2){iq2=true;continue;}
    if(c=='"'&&iq2){if(next=='"'){vbuf2+='"';i++;} else {iq2=false;continue;}}
    if(c==','&&!iq2){rbuf.push(vbuf2.trim());vbuf2='';continue;}
    if((c=='\n'||c=='\r')&&!iq2){if(c=='\r'&&next=='\n') i++;rbuf.push(vbuf2.trim());if(rbuf.some(c=>c!=='')) rows.push(rbuf); rbuf=[]; vbuf2=''; continue;}
    vbuf2+=c;
  }
  if(vbuf2||rbuf.length>0){rbuf.push(vbuf2.trim());if(rbuf.some(c=>c!=='')) rows.push(rbuf);}
  return rows;
}
function escapeCsv(v){return (v.includes(',')||v.includes('"')||v.includes('\n'))?`"${v.replace(/"/g,'""')}"`:v;}
function downloadCsv(rows,filename){const csv=rows.map(r=>r.map(escapeCsv).join(',')).join('\r\n');const bom=new Uint8Array([0xEF,0xBB,0xBF]);const blob=new Blob([bom,csv],{type:'text/csv;charset=utf-8'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(a.href);}

// ==================== CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ====================
const fileInput = document.getElementById('csvFile');
const fileNameDiv = document.getElementById('fileName');
const convertBtn = document.getElementById('convertBtn');
const downloadBtn = document.getElementById('downloadBtn');
const previewContent = document.getElementById('previewContent');

fileInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  fileNameDiv.textContent = file.name;
  const reader = new FileReader();
  reader.onload = function(evt){
    csvRows = parseCsv(evt.target.result);
    convertBtn.disabled = false;
  }
  reader.readAsText(file,'UTF-8');
});

// ==================== é…é€ä¼šç¤¾é¸æŠ ====================
async function loadFormats(){
  const carriers = ["yamato","sagawa","japanpost"];
  const select = document.getElementById('courierSelect');
  carriers.forEach(c=>{
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = COURIER_NAMES[c]||c;
    select.appendChild(opt);
  });
}
loadFormats();

// ==================== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º ====================
convertBtn.addEventListener('click',()=>{
  if(csvRows.length===0) return;
  const table = document.createElement('table');
  table.className = 'table-preview';
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  csvRows[0].forEach(h=>{
    const th = document.createElement('th');
    th.textContent = h;
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  const maxRows = Math.min(csvRows.length-1,5);
  for(let i=1;i<=maxRows;i++){
    const tr = document.createElement('tr');
    csvRows[i].forEach(v=>{
      const td = document.createElement('td');
      td.textContent = v;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  previewContent.innerHTML='';
  previewContent.appendChild(table);
  document.getElementById('previewSection').style.display='block';
  downloadBtn.style.display='inline-block';
});

// ==================== CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ====================
downloadBtn.addEventListener('click',()=>{
  if(csvRows.length===0) return;
  downloadCsv(csvRows,'converted.csv');
});
</script>
</body>
</html>

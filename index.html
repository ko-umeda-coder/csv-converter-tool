<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>CSVã‹ã‚“ãŸã‚“å¤‰æ›ãƒ„ãƒ¼ãƒ«</title>
<style>
:root {
  --primary: #0066cc;
  --primary-hover: #0052a3;
  --success: #28a745;
  --error: #dc3545;
  --bg-light: #f8f9fa;
  --border: #dee2e6;
  --text-dark: #212529;
  font-size: 18px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: 'Meiryo','Yu Gothic',sans-serif; line-height:1.8; background:var(--bg-light); padding:20px; color:var(--text-dark); }
.container { max-width:900px; margin:0 auto; }
.header { background: linear-gradient(135deg, var(--primary), #0080ff); color:white; padding:30px 25px; border-radius:12px; margin-bottom:30px; text-align:center; box-shadow:0 4px 6px rgba(0,0,0,0.1);}
.header h1 { font-size:2em; margin-bottom:10px; }
.header p { font-size:1.1em; opacity:0.95; }
.font-controls { background:white; padding:15px; border-radius:8px; margin-bottom:20px; text-align:center; box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.font-controls label { font-weight:bold; margin-right:15px; font-size:1.1em; }
.font-btn { padding:10px 18px; margin:0 5px; border:2px solid var(--border); background:white; border-radius:6px; cursor:pointer; font-size:1em; font-weight:bold; transition:all 0.3s; }
.font-btn:hover { background: var(--primary); color:white; border-color: var(--primary);}
.font-btn.active { background: var(--primary); color:white; border-color: var(--primary);}
.section { background:white; padding:30px; border-radius:12px; margin-bottom:25px; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.section h2 { font-size:1.6em; color: var(--primary); margin-bottom:25px; padding-bottom:12px; border-bottom:3px solid var(--primary);}
.help-box { background:#fff3cd; border-left:4px solid #ffc107; padding:15px; margin-bottom:20px; border-radius:6px; }
.help-box h3 { font-size:1.1em; color:#856404; margin-bottom:8px;}
.help-box ul { margin-left:20px; color:#856404;}
.help-box li { margin-bottom:5px;}
.form-group { margin-bottom:25px;}
.form-label { display:block; font-size:1.2em; font-weight:bold; margin-bottom:12px; color:var(--text-dark);}
.file-input-wrapper { position:relative; border:3px dashed var(--border); border-radius:12px; padding:40px 20px; text-align:center; background:var(--bg-light); cursor:pointer; transition:all 0.3s; }
.file-input-wrapper:hover { border-color: var(--primary); background:#e3f2fd; }
.file-input-wrapper.has-file { border-color: var(--success); background:#d4edda;}
.file-input-wrapper input[type="file"] { position:absolute; opacity:0; width:100%; height:100%; top:0; left:0; cursor:pointer;}
.file-icon { font-size:3em; margin-bottom:10px; }
.file-text { font-size:1.2em; font-weight:bold; color:var(--text-dark);}
.file-subtext { font-size:1em; color:#6c757d; margin-top:8px;}
.file-name { margin-top:15px; font-size:1.1em; color:var(--success); font-weight:bold;}
select { width:100%; padding:16px; font-size:1.2em; border:2px solid var(--border); border-radius:8px; background:white; cursor:pointer; transition:border-color 0.3s;}
select:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(0,102,204,0.1);}
.btn { width:100%; padding:18px; font-size:1.3em; font-weight:bold; border:none; border-radius:8px; cursor:pointer; transition:all 0.3s; min-height:60px; box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.btn-primary { background: var(--primary); color:white; }
.btn-primary:hover:not(:disabled) { background: var(--primary-hover); transform:translateY(-2px); box-shadow:0 4px 8px rgba(0,0,0,0.2);}
.btn-primary:disabled { background:#ccc; cursor:not-allowed; opacity:0.6;}
.message { display:none; padding:20px; margin:20px 0; border-radius:8px; font-size:1.2em; font-weight:bold; border-left:5px solid;}
.message.error { background:#f8d7da; border-color:var(--error); color:#721c24;}
.message.success { background:#d4edda; border-color:var(--success); color:#155724;}
.message.warning { background:#fff3cd; border-color:#ffc107; color:#856404;}
.history-item { background:var(--bg-light); border-left:5px solid var(--primary); padding:18px 20px; margin-bottom:15px; border-radius:8px; transition: transform 0.2s;}
.history-item:hover { transform:translateX(5px); box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.history-date { font-size:1.15em; font-weight:bold; color: var(--primary); margin-bottom:8px;}
.history-detail { font-size:1.05em; color: var(--text-dark); margin-bottom:5px;}
.history-label { font-weight:bold; color:#6c757d;}
.no-history { text-align:center; padding:40px; color:#6c757d; font-size:1.1em;}
.loading-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:9999;}
.loading-content { text-align:center; color:white;}
.spinner { width:60px; height:60px; border:6px solid rgba(255,255,255,0.3); border-top-color:white; border-radius:50%; animation: spin 1s linear infinite; margin:0 auto 20px;}
@keyframes spin { to { transform:rotate(360deg); } }
.loading-text { font-size:1.5em; font-weight:bold; }
*:focus { outline:3px solid var(--primary); outline-offset:2px;}
.preview-section { margin-top:25px; padding-top:25px; border-top:2px solid var(--border);}
.preview-title { font-size:1.3em; font-weight:bold; color:var(--text-dark); margin-bottom:15px;}
.table-preview { width:100%; border-collapse: collapse; margin-top:15px; font-size:0.95em; overflow-x:auto; display:block;}
.table-preview th, .table-preview td { border:1px solid var(--border); padding:10px; text-align:left;}
.table-preview th { background:#e9ecef; font-weight:bold;}
.ng-cell { background:#ffe5e5; font-weight:bold;}
.preview-note { color:#6c757d; font-size:0.95em; margin-top:10px; font-style:italic;}
@media (max-width:768px) { :root { font-size:16px; } .section { padding:20px; } .btn { padding:14px; } .font-btn { margin:5px 2px; } }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>ğŸ“¦ CSVã‹ã‚“ãŸã‚“å¤‰æ›ãƒ„ãƒ¼ãƒ«</h1>
    <p>å®…é…ä¾¿ç”¨CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç°¡å˜ã«å¤‰æ›ã§ãã¾ã™ï¼ˆæœ€å¤§200è¡Œï¼‰</p>
  </div>

  <div class="font-controls">
    <label>æ–‡å­—ã‚µã‚¤ã‚ºï¼š</label>
    <button class="font-btn" data-size="16px">å°</button>
    <button class="font-btn active" data-size="18px">æ¨™æº–</button>
    <button class="font-btn" data-size="22px">å¤§</button>
    <button class="font-btn" data-size="26px">ç‰¹å¤§</button>
  </div>

  <div class="section">
    <h2>â“ ä½¿ã„æ–¹</h2>
    <div class="help-box">
      <h3>ğŸ“ CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ã«ã¤ã„ã¦</h3>
      <ul>
        <li>å¿…é ˆã®åˆ—ï¼šã€Œ<strong>ä½æ‰€</strong>ã€</li>
        <li>ä»»æ„ã®åˆ—ï¼šã€Œé›»è©±ã€ã€Œãƒ¡ãƒ¼ãƒ«ã€</li>
        <li>ä¾‹ï¼šæ°å,ä½æ‰€,é›»è©±,ãƒ¡ãƒ¼ãƒ«</li>
      </ul>
      <p>â€»è¡Œæ•°ãŒ200ã‚’è¶…ãˆã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™</p>
    </div>
  </div>

  <div class="section">
    <h2>ğŸ”„ CSVå¤‰æ›</h2>
    <div id="message" class="message"></div>
    
    <div class="form-group">
      <label class="form-label">1ï¸âƒ£ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
      <div class="file-input-wrapper" id="fileWrapper">
        <input type="file" id="csvFile" accept=".csv">
        <div class="file-icon">ğŸ“„</div>
        <div class="file-text">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="file-subtext">ã¾ãŸã¯ã€ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
        <div class="file-name" id="fileName"></div>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">2ï¸âƒ£ å®…é…ä¼šç¤¾ã‚’é¸æŠ</label>
      <select id="courierSelect">
        <option value="Yamato">ãƒ¤ãƒãƒˆé‹è¼¸</option>
        <option value="Sagawa">ä½å·æ€¥ä¾¿</option>
        <option value="JapanPost">æ—¥æœ¬éƒµä¾¿</option>
      </select>
    </div>

    <button id="convertBtn" class="btn btn-primary" disabled>
      3ï¸âƒ£ å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    </button>

    <div id="previewSection" class="preview-section" style="display:none;">
      <div class="preview-title">ğŸ“Š ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœ€åˆã®10ä»¶ï¼‰</div>
      <div id="previewContent"></div>
      <p class="preview-note">â€»èµ¤è‰²ã®é …ç›®ã¯ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™</p>
    </div>
  </div>

  <div class="section">
    <h2>ğŸ“œ å¤‰æ›å±¥æ­´</h2>
    <div id="historyList"></div>
  </div>
</div>

<div id="loading" class="loading-overlay">
  <div class="loading-content">
    <div class="spinner"></div>
    <div class="loading-text">å‡¦ç†ä¸­ã§ã™...</div>
  </div>
</div>

<script>
// ==================== è¨­å®š ====================
const ADDRESS_LIMIT = { Yamato:{a1:35,a2:35}, Sagawa:{a1:40,a2:40}, JapanPost:{a1:50,a2:50} };
const MAX_HISTORY = 50;
const MAX_ROWS = 200;
const COURIER_NAMES = { Yamato:'ãƒ¤ãƒãƒˆé‹è¼¸', Sagawa:'ä½å·æ€¥ä¾¿', JapanPost:'æ—¥æœ¬éƒµä¾¿' };
let historyData = [];

// ==================== ãƒ˜ãƒ«ãƒ‘ãƒ¼ ====================
function parseCsv(text){
  const rows=[], row=[], MAX=MAX_ROWS;
  let r=[], v='', inQuotes=false;
  const lines=text.split(/\r\n|\n/);
  for(let i=0;i<lines.length;i++){
    if(i>=MAX){ showMessage(`è¡Œæ•°ãŒ${MAX}ã‚’è¶…ãˆã¦ã„ã¾ã™`, 'error'); break; }
    const line=lines[i], values=[];
    let val='', q=false;
    for(let j=0;j<line.length;j++){
      const c=line[j], next=line[j+1];
      if(c=='"' && !q){ q=true; continue; }
      if(c=='"' && q){ if(next=='"'){ val+='"'; j++; } else { q=false; continue; } }
      if(c==',' && !q){ values.push(val.trim()); val=''; continue; }
      val+=c;
    }
    values.push(val.trim());
    rows.push(values);
  }
  return rows;
}

function escapeCsv(v){ if(typeof v!=='string') v=String(v); return /[",\n]/.test(v)?`"${v.replace(/"/g,'""')}"`:v; }
function downloadCsv(rows,filename){ const csv=rows.map(r=>r.map(escapeCsv).join(',')).join('\r\n'); const bom=new Uint8Array([0xEF,0xBB,0xBF]); const blob=new Blob([bom,csv],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);}
function checkPhone(p){ if(!p) return'OK'; const v=p.replace(/[-\s()]/g,''); return /^\d{9,11}$/.test(v)?'OK':'NG'; }
function checkEmail(e){ if(!e) return'OK'; return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?'OK':'NG'; }
function splitAddress(a,c){ if(!a) return['','']; const lim=ADDRESS_LIMIT[c]||{a1:35,a2:35}; if(a.length<=lim.a1)return[a,'']; const sub=a.substring(0,lim.a1); const matches=[...sub.matchAll(/[\s\-ã€€ãƒ¼ã€ã€‚]/g)]; if(matches.length>0){ const last=matches[matches.length-1]; const idx=last.index+1; if(idx>lim.a1/2) return [a.substring(0,idx).trim(),a.substring(idx).trim()]; } return [a.substring(0,lim.a1).trim(),a.substring(lim.a1).trim()]; }

// ==================== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ====================
function showMessage(text,type='success'){ const m=document.getElementById('message'); m.textContent=text; m.className=`message ${type}`; m.style.display='block'; m.scrollIntoView({behavior:'smooth', block:'nearest'});}
function hideMessage(){ document.getElementById('message').style.display='none'; }

// ==================== å±¥æ­´ ====================
function saveHistory(item){ historyData.push(item); if(historyData.length>MAX_HISTORY) historyData.shift(); renderHistory(); }
function renderHistory(){ const div=document.getElementById('historyList'); div.innerHTML=''; if(historyData.length===0){ div.innerHTML='<div class="no-history">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; } historyData.slice().reverse().forEach(h=>{ const el=document.createElement('div'); el.className='history-item'; el.innerHTML=`<div class="history-date">${new Date(h.date).toLocaleString('ja-JP')}</div>
<div class="history-detail"><span class="history-label">å®…é…ä¼šç¤¾:</span> ${COURIER_NAMES[h.courier]||h.courier}</div>
<div class="history-detail"><span class="history-label">å¤‰æ›ä»¶æ•°:</span> ${h.count}ä»¶</div>
<div class="history-detail"><span class="history-label">ã‚¨ãƒ©ãƒ¼ä»¶æ•°:</span> ${h.ngCount}ä»¶</div>`; div.appendChild(el); }); }

// ==================== CSVå‡¦ç†ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ====================
function renderPreview(rows,courier,idxAddress,idxPhone,idxEmail){
  const previewDiv=document.getElementById('previewContent'); const previewSection=document.getElementById('previewSection'); previewDiv.innerHTML='';
  const table=document.createElement('table'); table.className='table-preview';
  const thead=document.createElement('thead'); const trh=document.createElement('tr');
  rows[0].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
  ['ä½æ‰€1','ä½æ‰€2','é›»è©±ãƒã‚§ãƒƒã‚¯','ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
  thead.appendChild(trh); table.appendChild(thead);
  const tbody=document.createElement('tbody'); const maxRows=Math.min(rows.length-1,10); let previewNgCount=0;
  for(let i=1;i<=maxRows;i++){
    const row=rows[i]; const tr=document.createElement('tr'); row.forEach(cell=>{ const td=document.createElement('td'); td.textContent=cell||''; tr.appendChild(td); });
    const addr=row[idxAddress]||''; const [a1,a2]=splitAddress(addr,courier);
    const td1=document.createElement('td'); td1.textContent=a1; tr.appendChild(td1);
    const td2=document.createElement('td'); td2.textContent=a2; if(a2&&a2.length>ADDRESS_LIMIT[courier].a2){ td2.classList.add('ng-cell'); previewNgCount++; } tr.appendChild(td2);
    const phoneStatus=idxPhone!==-1?checkPhone(row[idxPhone]):'OK'; const tdPhone=document.createElement('td'); tdPhone.textContent=phoneStatus; if(phoneStatus==='NG'){ tdPhone.classList.add
